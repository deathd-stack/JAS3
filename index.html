<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JAS 운영앱 v1.0</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
body { margin:0; font-family:-apple-system,BlinkMacSystemFont; background:#f2f2f2; }
.header {
    background:#ff6a00;
    color:white;
    font-size:22px;
    font-weight:bold;
    padding:15px;
    text-align:center;
}
.center { text-align:center; margin:15px; }
button {
    background:#ff6a00;
    color:white;
    border:none;
    padding:10px 16px;
    border-radius:8px;
}
.groupGrid {
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:10px;
    margin:15px;
}
.groupBtn {
    padding:10px;
    border-radius:8px;
    text-align:center;
    color:white;
    font-weight:bold;
}
.card {
    background:white;
    margin:12px;
    padding:12px;
    border-radius:10px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
.row {
    display:flex;
    justify-content:space-between;
    margin-top:6px;
}
.time { color:red; font-weight:bold; }
.memoBtn {
    background:#ff6a00;
    font-size:12px;
    padding:6px 10px;
}
.popup {
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.4);
    display:none;
    justify-content:center;
    align-items:center;
}
.popupContent {
    background:white;
    width:90%;
    max-width:400px;
    padding:15px;
    border-radius:10px;
}
.popupContent input {
    width:100%;
    margin-top:5px;
    margin-bottom:10px;
}
.smallRow {
    display:flex;
    justify-content:space-between;
    gap:6px;
}
.smallRow input {
    width:70px;
}
</style>
</head>

<body>

<div class="header">JAS 운영 시스템</div>

<div class="center">
<input type="file" id="upload" accept="image/*">
</div>

<div id="loading" class="center"></div>
<div id="groupSelect"></div>
<div id="scheduleArea"></div>

<!-- 메모 팝업 -->
<div class="popup" id="memoPopup">
<div class="popupContent">
<h3>도착 메모</h3>

<label>CMPT 1</label>
<input id="cmpt1">

<label>CMPT 2</label>
<input id="cmpt2">

<label>CMPT 3</label>
<input id="cmpt3">

<label>CMPT 4</label>
<input id="cmpt4">

<div class="smallRow">
<input id="t" placeholder="T" maxlength="3">
<input id="ds" placeholder="D/S" maxlength="3">
<input id="b" placeholder="B" maxlength="3">
<input id="g" placeholder="G" maxlength="3">
</div>

<div class="center">
<button onclick="saveMemo()">저장</button>
<button onclick="closePopup()">닫기</button>
</div>

</div>
</div>

<script>

let schedules = [];
let currentDate = new Date().toISOString().split("T")[0];
let currentMemoKey = "";

document.getElementById("upload").addEventListener("change", async function(e){

    const file = e.target.files[0];
    if(!file) return;

    document.getElementById("loading").innerText="OCR 분석중...";

    const result = await Tesseract.recognize(file,"eng");
    parseOCR(result.data.text);

    document.getElementById("loading").innerText="";
});

function parseOCR(text){

    schedules = [];
    const lines = text.split("\n");

    lines.forEach(line=>{
        const hl = line.match(/HL\d{4}/);
        const c7 = line.match(/7C\d{4}/);
        const time = line.match(/\d{2}:\d{2}/);
        const group = line.match(/\b\d{1,2}\b/);

        if(hl && time && group){

            let type="";
            if(c7){
                const fourth = parseInt(c7[0][3]);
                type = (fourth % 2 === 0) ? "도착" : "출발";
            }

            schedules.push({
                hl:hl[0],
                c7:c7?c7[0]:"",
                time:time[0],
                group:group[0],
                type:type
            });
        }
    });

    renderGroupSelect();
}

function renderGroupSelect(){
    const container = document.getElementById("groupSelect");
    container.innerHTML='<div class="groupGrid"></div>';
    const grid = container.querySelector(".groupGrid");

    const uniqueGroups = [...new Set(schedules.map(s=>s.group))];

    uniqueGroups.forEach(g=>{
        const btn = document.createElement("div");
        btn.className="groupBtn";
        btn.style.background=getColor(g);
        btn.innerText=g+"조";
        btn.onclick=()=>renderSchedule(g);
        grid.appendChild(btn);
    });
}

function renderSchedule(group){

    const area = document.getElementById("scheduleArea");
    area.innerHTML="";

    schedules.filter(s=>s.group==group)
    .forEach(s=>{
        area.innerHTML+=`
        <div class="card">
            <div><b>${s.c7? s.c7+" / ":""}${s.hl}</b></div>
            <div class="row">
                <span class="time">${s.time}</span>
                ${s.type==="도착"?
                `<button class="memoBtn" onclick="openMemo('${s.c7}','${s.hl}')">메모</button>`:""}
            </div>
        </div>`;
    });
}

function getColor(g){
    const num=parseInt(g);
    if(num>=1&&num<=8) return "#1976D2";
    if(num>=9&&num<=16) return "#FBC02D";
    if(num>=17&&num<=24) return "#F57C00";
    return "#9E9E9E";
}

function openMemo(c7,hl){

    currentMemoKey = currentDate+"_"+c7+"_"+hl;
    const saved = JSON.parse(localStorage.getItem(currentMemoKey)||"{}");

    document.getElementById("cmpt1").value=saved.cmpt1||"";
    document.getElementById("cmpt2").value=saved.cmpt2||"";
    document.getElementById("cmpt3").value=saved.cmpt3||"";
    document.getElementById("cmpt4").value=saved.cmpt4||"";
    document.getElementById("t").value=saved.t||"";
    document.getElementById("ds").value=saved.ds||"";
    document.getElementById("b").value=saved.b||"";
    document.getElementById("g").value=saved.g||"";

    document.getElementById("memoPopup").style.display="flex";
}

function saveMemo(){

    const data={
        cmpt1:cmpt1.value,
        cmpt2:cmpt2.value,
        cmpt3:cmpt3.value,
        cmpt4:cmpt4.value,
        t:t.value,
        ds:ds.value,
        b:b.value,
        g:g.value
    };

    localStorage.setItem(currentMemoKey,JSON.stringify(data));
    closePopup();
}

function closePopup(){
    document.getElementById("memoPopup").style.display="none";
}

</script>

</body>
</html>